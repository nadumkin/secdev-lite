## ADR: **JWT TTL + Refresh + Rotation**

**Status**: Proposed

### **Context**

**Risk**: **R-02** “JWT Replay/Validation Gaps” (L=4, I=5, Score=20)
**DFD**: Edge → API (JWT)
**NFR**: **NFR-006 (#129)**

**Assumptions**:

* Публичный API-гейтвей.
* Стейтлес-сервисы.
* Токены передаются через HTTPS.
* Нет MTLS на стороне клиента.

### **Decision**

Для защиты от повторного использования украденных или просроченных JWT, а также для предотвращения атак с подменой токенов, будем использовать следующие меры:

* **TTL для access token**: Установить на **15-30 минут** (короткий срок жизни токенов).
* **TTL для refresh token**: Установить на **7-30 дней** (для переавторизации).
* **Ротация ключей JWT**: Внедрить автоматическую ротацию ключей через **JWKS (JSON Web Key Set)**, с обновлением ключей не реже чем раз в 7 дней или по запросу.
* **Проверка claims JWT**: Строгая проверка для `iss` (issuer), `aud` (audience), `exp` (expiration) и `iat` (issued at). В случае несоответствия или просроченных токенов — отправляем **401 Unauthorized**.
* **Механизм отзыва**: Поддерживать список отзыва refresh токенов, чтобы аннулировать украденные или скомпрометированные токены. Логины должны приводить к добавлению refresh токенов в черный список.

**Область применения**:

* **Эндпойнты**: Все write-эндпойнты, например, `/api/profile`, `/api/settings`, и любые другие защищенные эндпойнты.
* **Уровень**: Политика проверки токенов на уровне гейтвея и работа с refresh токенами.

### **Alternatives**

* **Alt B**: Использование MTLS для машинных клиентов.

  * **Почему не выбрали**: Высокая сложность внедрения и интеграции на клиентской стороне.
* **Alt C**: Использование OAuth Device Flow для неинтерактивных клиентов.

  * **Почему не выбрали**: Требуется значительная переработка текущей архитектуры клиента, что добавляет сложности.

Выбранное решение — JWT TTL + Refresh + Rotation — является оптимальным для минимизации рисков, связанных с повторным использованием токенов, и не требует серьезных изменений в архитектуре, что позволяет быстро внедрить его с минимальными затратами и усилиями.
### **Consequences**

**Положительные эффекты**:

* Снижение окна атаки для повторных атак с использованием украденных токенов.
* Повышенная безопасность доступа к защищенным ресурсам.
* Лучшая защита от использования скомпрометированных или устаревших токенов.

**Отрицательные эффекты**:

* Сложность управления сессиями и токенами.
* Увеличение задержки из-за дополнительной проверки.
* Возможные проблемы с совместимостью старых клиентов, использующих просроченные refresh токены.

### **DoD / Acceptance**

**Given** просроченный access token с истекшим сроком действия,
**When** выполняется запрос к защищенному эндпойнту (`POST /api/profile`),
**Then** ответ должен быть **401 Unauthorized** с `Content-Type: application/problem+json` и соответствующим сообщением об ошибке в формате RFC7807.

**Checks**:

* **Test**: Интеграционные тесты, проверяющие, что просроченные JWT приводят к **401 Unauthorized**.
* **Log**: Логи должны содержать `correlation_id`, а при попытке использования просроченного токена должна быть зафиксирована ошибка.
* **Scan/Policy**: Токены должны проверяться против списка отзыва refresh токенов.
* **Metric/SLO**: Ошибки проверки JWT должны составлять не более **1%** от общего числа запросов.

### **Rollback / Fallback**

Для безопасного отката:

* Можно изменить конфигурацию проверки JWT и политику TTL.
* В случае возникновения проблем, откатить параметры ротации ключей и настройку механизма отзыва refresh токенов.
* Мониторинг ошибок аутентификации и токенов.

### **Trace**

* **DFD**: S04, Edge → API (JWT).
* **STRIDE**: R-02 (JWT Replay/Validation Gaps).
* **Risk scoring**: R-02 (Top-2, Score=20).
* **NFR**: **NFR-006 (#129)**.

### **Ownership & Dates**

* **Owner**: Security Lead
* **Reviewers**: DevSecOps, SRE, Backend Lead
* **Date created**: 2025-10-12
* **Last updated**: 2025-10-12