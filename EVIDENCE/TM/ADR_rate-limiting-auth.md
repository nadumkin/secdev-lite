# ADR: **Global & per-route rate-limits + body-size limits**

**Status**: Proposed

## Context

**Risk**: R-01 "Abuse/DoS публичных auth-эндпоинтов" (L=4, I=4, Score=16)
**DFD**: Edge Internet → API (/verify-email, /register)
**NFR**: **NFR-001**, **NFR-002**, need NFR: RateLimit-register
**Assumptions**:

* Публичный API, подвержен атакам типа DoS с помощью флуда запросами или чрезмерных тел.
* Важно, чтобы решение было универсальным для всех auth-эндпоинтов.
* Необходимость настройки лимитов на уровне отдельных эндпоинтов и глобально.

## Decision

Внедрение глобальных лимитов на количество запросов и размер тела на уровне всех auth-эндпоинтов:

* **Body size limit**: Максимальный размер запроса 64 KiB для всех запросов.
* **Request rate limit**: Максимальное количество запросов для каждого IP или токена на уровне всех auth-эндпоинтов - 10 запросов в минуту.
* **Per-route limits**: Лимиты для /register и /verify-email эндпоинтов могут быть адаптированы на основе нагрузки.

**Границы действия**: Все публичные API эндпоинты для аутентификации (например, `/api/auth/register`, `/api/auth/verify-email`).
**Этап/слой**: Применение на уровне API gateway и маршрутизации, с флагами на уровне сервисов для более точной настройки.

## Alternatives

* **Alt A**: Лимитирование только на уровне /verify-email (только для подтверждения).
  **Почему не выбрали**: Не обеспечивает защиты для других критичных маршрутов, таких как регистрация пользователей.

* **Alt B**: Использование внешней защиты от DoS атак (например, WAF).
  **Почему не выбрали**: Зависимость от стороннего решения, сложность интеграции и настройки, не такая гибкость в контроле.

## Consequences

**Положительные**:

* Защита всех критичных auth-эндпоинтов от DoS и флуда.
* Простота интеграции и настройки, контроль на уровне API.
* Повышение надежности и доступности сервиса.

**Негативные/издержки**:

* Потенциальные ложные срабатывания, если система работает с пиковыми нагрузками (например, массовая регистрация).
* Может быть сложно интегрировать с существующими решениями для балансировки нагрузки.

## DoD / Acceptance

**Given**: Загрузки тела запроса и запросы API находятся в пределах лимита.
**When**: Запросы превышают лимит по размеру или количеству (например, более 64 KiB или 10 запросов/мин).
**Then**: Клиент получает ответ 429 с корректным заголовком `Retry-After`.
**Checks**:

* **test**: e2e-тесты на лимит запроса и тела.
* **log**: Логирование события с `429` и `Retry-After` в ответе.
* **scan/policy**: Проверка на соответствие конфигурации лимитов в API Gateway.
* **metric/SLO**: Слежение за количеством 429 ответов, недопущение превышения 5% от всех запросов.

## Rollback / Fallback

Для отката решения можно временно уменьшить лимиты на запросы (например, с 10 запросов/мин до 5 запросов/мин) и вернуть исходные настройки в API Gateway.
Мониторинг через метрики и логи будет показывать откат или снижение нагрузки на сервис.

## Trace

* **DFD**: [Edge Internet → API (JWT)](SEMENARS/S05/S05_DFD.md)
* **STRIDE**: R-01, R-02
* **Risk scoring**: R-01 (Score=16)
* **NFR**: NFR-001, NFR-002, NFR-RateLimit-register
* **Issues**: #123 (создание правил rate-limiting в API Gateway)

## Ownership & Dates

**Owner**: DevSecOps
**Reviewers**: Security Team, Backend Team
**Date created**: 2025-10-12
**Last updated**: 2025-10-12

## Open Questions

* Как точно определить оптимальное значение лимита для каждого из эндпоинтов (например, для массовой регистрации)?
* Нужно ли использовать динамическое изменение лимитов в зависимости от нагрузки?