## US-001 - Регистрация пользователя

* **Роль-Цель-Ценность:** Как гость, я хочу зарегистрировать учётную запись, чтобы получить доступ к функционалу приложения.
* **Кратко:** Регистрация с подтверждением e-mail.
* **API/Endpoints (пример):** `POST /api/auth/register`, `POST /api/auth/verify-email`
* **NFR hooks:** `Security-AuthN`, `InputValidation`, `RateLimiting`, `API-Contract/Errors`, `Privacy/PII`

## US-002 - Вход в систему (Login)

* **Роль-Цель-Ценность:** Как пользователь, я хочу входить в систему по логину/паролю, чтобы управлять своими данными.
* **Кратко:** Вход, выдача JWT/сессии, защита от перебора.
* **API/Endpoints:** `POST /api/auth/login`
* **NFR hooks:** `Security-AuthN`, `RateLimiting`, `Timeouts/Retry`, `Observability/Logging`

## US-013 - Импорт CSV

* **Роль-Цель-Ценность:** Как менеджер, я хочу загружать CSV с данными, чтобы быстро обновлять систему.
* **Кратко:** Валидация схемы/размера, фоновые задания.
* **API/Endpoints:** `POST /api/import/csv`
* **NFR hooks:** `InputValidation`, `Data-Integrity`, `Scalability`, `Observability/Logging`

## Таблица реестра
| ID      | User Story / Feature     | Category                          | Requirement (NFR)                                                                                                                                                                                                                                                                        | Rationale / Risk                                                                                                                                     | Acceptance (G-W-T)                                                                                                                                                                                                                                                                                                                     | Evidence (test/log/scan/policy)                                                                               | Trace (issue/link) | Owner         | Status   | Priority    | Severity      | Tags                                    |
|---------|--------------------------|-----------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------|--------------------|---------------|----------|-------------|---------------|-----------------------------------------|
| NFR-001 | Регистрация пользователя | **Rate Limiting / Throttling**    | На <POST /api/auth/verify-email> действует лимит 3/min на IP адресс; превышение → 429 + Retry-After                                                                                                                                                                                      | Защита от DDoS                                                                                                                                       | **Given** ip адрес <br>**When** выполняется limit+N запросов к <endpoint> за 60 секунд <br>**Then** лишние запросы получают 429 и корректный заголовок Retry-After                                                                                                                                                                     | e2e-тест лимита; логи с 429 и `Retry-After`                                                                   | #123               | DevSecOps     | Proposed | P1 - High   | S2 - Major    | инфраструкура, безопасность             |
| NFR-002 | Регистрация пользователя | **Security-InputValidation**      | Для `POST /api/auth/register`: размер тела ≤ **64 KiB**, `Content-Type=application/json`, разрешены только поля `{email, password}`; **extra** поля → **400**; тело >64 KiB → **413**.                                                                                                   | Защита от DoS/грязных данных                                                                                                                         | **Given** тело запроса размером 128 KiB **When** `POST /api/auth/register` **Then** ответ **413** с телом в RFC 7807;<br>**Given** тело с незадекларированным полем `debug` **When** `POST /api/auth/register` **Then** **400** в RFC 7807; схема DTO отклоняет неизвестные поля.                                                      | e2e: валидатор DTO; контракт-схема; логи 400/413                                                              | #125               | team-a        | Draft    | P1 - High   | S2 - Major    | security,input,validation               |
| NFR-003 | Регистрация пользователя | **API-Contract/Errors**           | Ошибки для `POST /api/auth/register` и `POST /api/auth/verify-email` отдаются в формате **RFC 7807** (`application/problem+json`) без стэктрейсов; включён `correlation_id`.                                                                                                             | Предсказуемость API, отсутствие утечек                                                                                                               | **Given** серверная ошибка при `POST /api/auth/register` **When** клиент получает ответ **Then** `Content-Type=application/problem+json`, присутствуют `type/title/status/detail`, нет стэктрейсов, есть `correlation_id`;<br>**Given** бизнес-ошибка в `POST /api/auth/verify-email` **Then** тело также соответствует RFC 7807.      | контракт-тесты ошибок; пример problem+json в e2e                                                              | #126               | team-a        | Proposed | P1 - High   | S2 - Major    | api-contract,errors,observability       |
| NFR-004 | Регистрация пользователя | **Privacy/PII**                   | PII (e-mail, IP, verification token) **не логируются**; сырые PII и незавершённые регистрации хранятся не дольше **30 дней** (ретенция/удаление по расписанию).                                                                                                                          | Приватность/комплаенс, снижение рисков утечки                                                                                                        | **Given** DTO с `email` и `ip` **When** выполняется логирование на любом уровне **Then** поля PII замаскированы/отсутствуют;<br>**Given** учётная запись осталась неподтверждённой **When** проходит 30 дней **Then** запись и связанный verification-токен удаляются согласно политике ретенции; наличие задания ретенции проверяемо. | пример логов с маскировкой; регламент ретенции; job лог                                                       | #127               | DevSecOps     | Proposed | P1 - High   | S2 - Major    | privacy,pii,compliance,retention        |
| NFR-005 | Вход в систему           | **RateLimiting**                  | На `POST /api/auth/login` действует лимит **5 запросов/мин** на пару *(username, IP)* и **30 запросов/мин** на IP; превышение → **429** + заголовок **Retry-After** (в секундах).                                                                                                        | Снижает риск перебора паролей и DoS на точке входа.                                                                                                  | **Given** валидная пара *(username, IP)* с активным лимитом, **When** выполняется **6-й** запрос к `/api/auth/login` в течение 60 с, **Then** ответ **429** с заголовком `Retry-After > 0`. **И** при 31-м запросе с одного IP за 60 с — также **429**.                                                                                | e2e-тест лимитов; логи 429 с `Retry-After`; дашборд по 429.                                                   | #128               | BE Lead, SRE  | Proposed | P1 - High   | S1 - Critical | login, brute-force, throttling          |
| NFR-006 | Вход в систему           | **Security-AuthN**                | Все write-эндпойнты, **кроме** `/api/auth/login`, требуют валидный JWT (подпись, `exp`, `aud`, `iss`); истёкший/некорректный → **401** с телом в **RFC 7807**.                                                                                                                           | Базовая линия безопасности, предотвращение неавторизованных действий.                                                                                | **Given** истёкший JWT, **When** `POST /api/profile` (пример write), **Then** ответ **401** с `Content-Type: application/problem+json` и полями `type/title/status/detail`, без стэктрейсов, с `correlation_id`.                                                                                                                       | Интеграционный тест 401; пример ответа 401; настройка JWT-валидации в gateway/service.                        | #129               | Security Lead | Proposed | P1 - High   | S1 - Critical | jwt, rfc7807, authn                     |
| NFR-007 | Вход в систему           | **Timeouts/Retry/CircuitBreaker** | Исходящий вызов к `user-store` при `/api/auth/login`: timeout **≤ 1.5s**, retry **≤ 1** с джиттером 100–300 ms; при доле ошибок **≥ 50%** за **1 мин** включается circuit-breaker на **30 s**; суммарное ожидание ≤ **2 s**.                                                             | Избегает «зависаний» и лавинной нагрузки при деградации зависимостей.                                                                                | **Given** недоступен `user-store`, **When** клиент вызывает `/api/auth/login`, **Then** выполняется не более **1** повторной попытки с джиттером, суммарное ожидание ответа **≤ 2 s**, и при ошибках **≥ 50%/мин** включается breaker (ошибки короткого типа 503/`problem+json`).                                                      | Конфиг HTTP-клиента; интеграционный тест отказов; логи включения breaker.                                     | #130               | Security Lead | Proposed | P1 - High   | S2 - Major    | resilience, breaker, retries            |
| NFR-008 | Вход в систему           | **Observability/Logging**         | Все запросы логируются в **JSON** и содержат **correlation_id** на каждом этапе; если заголовок `X-Correlation-ID` отсутствует — генерируется. Лог содержит: метод, путь, статус, `correlation_id`, результат аутентификации (успех/ошибка-код), без секретов.                           | Сквозная трассировка инцидентов без утечек чувствительных данных.                                                                                    | **Given** запрос к `/api/auth/login` с `X-Correlation-ID=abcd-1234`, **When** он проходит через сервис, **Then** в логах присутствует запись с `correlation_id=abcd-1234`, ключевыми полями и без полей секретов.                                                                                                                      | Шаблон структурного лога; сплунк/лог-поиск по `correlation_id`; контракт-тест логов (masking).                | #131               | SRE           | Proposed | P2 - Medium | S2 - Major    | logging, json, correlation-id, pii-safe |
| NFR-009 | Импорт CSV               | **Security-InputValidation**      | Для POST `/api/import/csv`: максимальный размер тела ≤ **10 MiB**, MIME-тип строго `text/csv`; схема CSV должна содержать только разрешённые столбцы (`id`, `name`, `email`, `created_at`); неизвестные поля или неверный тип данных приводят к **400**, превышение размера — к **413**. | Предотвращает DoS-атаки, загрузку повреждённых или нерелевантных файлов, защищает от инъекций и потери консистентности данных.                       | **Given** CSV-файл 15 MiB с лишним столбцом `age` и неверным MIME-типом<br>**When** пользователь с ролью `manager` выполняет POST `/api/import/csv`<br>**Then** ответ имеет код 413 или 400, тело в формате RFC 7807, без стэктрейса, с `correlation_id`.                                                                              | e2e-тест `import-csv-validation`; схема DTO-валидатора; пример логов 413.                                     | #132               | backend       | Proposed | P1 – High   | S2 – Major    | validation,input,csv                    |
| NFR-010 | Импорт CSV               | **Data-Integrity**                | Импорт выполняется в рамках одной транзакции: при наличии хотя бы одной ошибки валидации весь CSV откатывается. В БД не должно появляться частично вставленных данных. Проверка формата, типов и уникальности выполняется до коммита.                                                    | Обеспечивает атомарность и целостность данных, исключает расхождения между логикой импорта и фактическим содержимым таблиц.                          | **Given** CSV-файл с 100 строками, где 3 содержат некорректные email-адреса<br>**When** выполняется POST `/api/import/csv`<br>**Then** импорт завершается ошибкой, транзакция откатывается, а в БД отсутствуют новые записи.                                                                                                           | Интеграционный тест `import-rollback`; логи транзакций БД; политика миграций.                                 | #133               | backend       | Proposed | P1 – High   | S1 – Critical | integrity,transaction,rollback          |
| NFR-011 | Импорт CSV               | **Scalability**                   | Сервис должен сохранять стабильную производительность при увеличении объёма импорта в 2 раза. При росте размера CSV с **50 MB → 100 MB**, время обработки одного задания увеличивается не более чем в **1.5×**, без превышения **1 %** ошибок `5xx`.                                     | Гарантирует устойчивость системы при росте числа импорируемых файлов или объёма данных, подтверждает корректность работы фоновых заданий и очередей. | **Given** очередь фоновых заданий с CSV-файлами объёмом 50 MB<br>**When** нагрузка увеличена до 100 MB на файл<br>**Then** среднее время выполнения задачи возрастает ≤ 1.5 × базового, доля ошибок `5xx` ≤ 1 %.                                                                                                                       | Нагрузочный тест `import-scale-test`; метрики автоскейлинга; отчёт Prometheus/Grafana.                        | #134               | devops        | Proposed | P2 – Medium | S2 – Major    | scalability,queue,background            |
| NFR-012 | Импорт CSV               | **Performance**                   | Для POST `/api/import/csv`: P95 времени отклика ≤ **500 мс** при нагрузке **20 RPS** в течение **5 минут**, доля ошибок ≤ **1 %**.                                                                                                                                                       | Обеспечивает приемлемое время отклика при массовых загрузках и согласуется с целевыми SLO.                                                           | **Given** сервис находится в рабочем состоянии<br>**When** нагрузка 20 RPS на `/api/import/csv` удерживается 5 мин<br>**Then** P95 ≤ 500 мс и error rate ≤ 1 %.                                                                                                                                                                        | Нагрузочный тест `load-20rps`; метрика `http_server_requests_seconds{quantile="0.95"}`; отчёт Gatling/JMeter. | #135               | qa            | Proposed | P2 – Medium | S3 – Minor    | performance,slo,latency                 |
