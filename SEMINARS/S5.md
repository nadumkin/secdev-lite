## ADR: **JWT TTL + Refresh + Rotation**

**Status**: Proposed

### **Context**

**Risk**: **R-02** “JWT Replay/Validation Gaps” (L=4, I=5, Score=20)
**DFD**: Edge → API (JWT)
**NFR**: **NFR-006 (#129)**

**Assumptions**:

* Публичный API-гейтвей.
* Стейтлес-сервисы.
* Токены передаются через HTTPS.
* Нет MTLS на стороне клиента.

### **Decision**

Для защиты от повторного использования украденных или просроченных JWT, а также для предотвращения атак с подменой токенов, будем использовать следующие меры:

* **TTL для access token**: Установить на **15-30 минут** (короткий срок жизни токенов).
* **TTL для refresh token**: Установить на **7-30 дней** (для переавторизации).
* **Ротация ключей JWT**: Внедрить автоматическую ротацию ключей через **JWKS (JSON Web Key Set)**, с обновлением ключей не реже чем раз в 7 дней или по запросу.
* **Проверка claims JWT**: Строгая проверка для `iss` (issuer), `aud` (audience), `exp` (expiration) и `iat` (issued at). В случае несоответствия или просроченных токенов — отправляем **401 Unauthorized**.
* **Механизм отзыва**: Поддерживать список отзыва refresh токенов, чтобы аннулировать украденные или скомпрометированные токены. Логины должны приводить к добавлению refresh токенов в черный список.

**Область применения**:

* **Эндпойнты**: Все write-эндпойнты, например, `/api/profile`, `/api/settings`, и любые другие защищенные эндпойнты.
* **Уровень**: Политика проверки токенов на уровне гейтвея и работа с refresh токенами.

### **Alternatives**

* **Alt B**: Использование MTLS для машинных клиентов.

  * **Почему не выбрали**: Высокая сложность внедрения и интеграции на клиентской стороне.
* **Alt C**: Использование OAuth Device Flow для неинтерактивных клиентов.

  * **Почему не выбрали**: Требуется значительная переработка текущей архитектуры клиента, что добавляет сложности.

Выбранное решение — JWT TTL + Refresh + Rotation — является оптимальным для минимизации рисков, связанных с повторным использованием токенов, и не требует серьезных изменений в архитектуре, что позволяет быстро внедрить его с минимальными затратами и усилиями.
### **Consequences**

**Положительные эффекты**:

* Снижение окна атаки для повторных атак с использованием украденных токенов.
* Повышенная безопасность доступа к защищенным ресурсам.
* Лучшая защита от использования скомпрометированных или устаревших токенов.

**Отрицательные эффекты**:

* Сложность управления сессиями и токенами.
* Увеличение задержки из-за дополнительной проверки.
* Возможные проблемы с совместимостью старых клиентов, использующих просроченные refresh токены.

### **DoD / Acceptance**

**Given** просроченный access token с истекшим сроком действия,
**When** выполняется запрос к защищенному эндпойнту (`POST /api/profile`),
**Then** ответ должен быть **401 Unauthorized** с `Content-Type: application/problem+json` и соответствующим сообщением об ошибке в формате RFC7807.

**Checks**:

* **Test**: Интеграционные тесты, проверяющие, что просроченные JWT приводят к **401 Unauthorized**.
* **Log**: Логи должны содержать `correlation_id`, а при попытке использования просроченного токена должна быть зафиксирована ошибка.
* **Scan/Policy**: Токены должны проверяться против списка отзыва refresh токенов.
* **Metric/SLO**: Ошибки проверки JWT должны составлять не более **1%** от общего числа запросов.

### **Rollback / Fallback**

Для безопасного отката:

* Можно изменить конфигурацию проверки JWT и политику TTL.
* В случае возникновения проблем, откатить параметры ротации ключей и настройку механизма отзыва refresh токенов.
* Мониторинг ошибок аутентификации и токенов.

### **Trace**

* **DFD**: S04, Edge → API (JWT).
* **STRIDE**: R-02 (JWT Replay/Validation Gaps).
* **Risk scoring**: R-02 (Top-2, Score=20).
* **NFR**: **NFR-006 (#129)**.
* **Issues**: Ссылки на задачи для внедрения.

### **Ownership & Dates**

* **Owner**: Security Lead
* **Reviewers**: DevSecOps, SRE, Backend Lead
* **Date created**: 2025-10-12
* **Last updated**: 2025-10-12

### **Open Questions**

* Как будет безопасно управляться и распределяться ключи подписания JWT между сервисами?
* Будем ли мы поддерживать глобальный список отзыва refresh токенов, или ограничимся лишь высокорисковыми пользователями?
---
## Матрица вариантов для решения **R-02**: "JWT TTL + Refresh + Rotation"

### 0) Контекст риска (из S04)

* **Risk-ID**: **R-02**
* **Threat**: **S** (Spoofing)
* **DFD element/edge**: **Edge: API → User (JWT)**
* **NFR link (ID)**: **NFR-006 (#129)**
* **L×I (1-5)**: **L=4, I=5, Score=20**
* **Ограничения/предпосылки**:

  * Публичный API-гейтвей.
  * Стейтлес-сервисы.
  * Токены передаются через HTTPS.
  * Нет MTLS на стороне клиента.



### 1) Критерии и шкалы (1-5)

**Польза (чем больше - тем лучше, ↑):**

* **Security impact (↑)**: насколько альтернатива снижает риск.
* **Blast radius reduction (↑)**: насколько сужает возможный ущерб (например, только один тенант или аккаунт вместо всей системы).

**Стоимость/сложность (чем меньше - тем лучше, ↓):**

* **Complexity (↓)**: сложность внедрения (код, конфигурация, политики).
* **Time-to-mitigate (↓)**: сколько времени потребуется для внедрения и получения результатов (в днях/спринтах).
* **Dependencies (↓)**: внешние и внутренние зависимости (команды, провайдеры, миграции).

**Итоговые метрики:**

* **Benefit = Security impact + Blast radius reduction**
* **Cost = Complexity + Time-to-mitigate + Dependencies**
* **Net = Benefit − Cost**


### 2) Таблица сравнения вариантов

| Alternative | Summary                                                               | Security impact (↑,1-5) | Blast radius reduction (↑,1-5) | Complexity (↓,1-5) | Time-to-mitigate (↓,1-5) | Dependencies (↓,1-5) | **Benefit** | **Cost** | **Net** | Notes                                                                            |
|-------------|-----------------------------------------------------------------------|------------------------:|-------------------------------:|-------------------:|-------------------------:|---------------------:|------------:|---------:|--------:|----------------------------------------------------------------------------------|
| **A**       | Короткий TTL для access токенов и refresh токенов, ротация ключей JWT |                       5 |                              4 |                  2 |                        2 |                    3 |       **9** |    **7** |  **+2** | Простая и быстрая реализация без сложных зависимостей                            |
| **B**       | Взаимная аутентификация TLS (mTLS) между клиентом и сервисом          |                       5 |                              5 |                  5 |                        5 |                    5 |      **10** |   **20** | **−10** | Сложное внедрение, требует изменений на клиенте и в инфраструктуре               |
| **C**       | OAuth Device Flow для неинтерактивных клиентов                        |                       4 |                              4 |                  3 |                        3 |                    4 |       **8** |   **14** |  **−6** | Хорошо подходит для неинтерактивных клиентов, но требует изменений в архитектуре |


### 3) Тай-брейкеры при равенстве Net

Если Net окажется одинаковым, можно использовать следующие критерии для выбора:

* **Compliance/Privacy**: Как альтернатива влияет на требования приватности или комплаенса (например, GDPR).
* **Maintainability**: Насколько просто сопровождать решение в долгосрочной перспективе.
* **Team fit**: Есть ли у команды опыт или экспертиза для внедрения этой альтернативы.
* **Observability**: Как легко будет отслеживать работоспособность и ошибки.
* **Rollback safety**: Насколько безопасен откат, если решение не будет работать должным образом.


### 4) Решение

**Chosen alternative**: **A**
Почему: Альтернатива A — это решение, которое предоставляет оптимальное соотношение безопасности и простоты внедрения. Мы выбираем этот вариант, потому что он минимизирует риски, связанные с повторным использованием украденных или просроченных JWT, при этом не требует сложных изменений в инфраструктуре или клиентских приложениях.
**Следующие шаги**:

1. Установить TTL для access токенов на 15-30 минут, для refresh токенов на 7-30 дней.
2. Внедрить ротацию ключей JWT через JWKS.
3. Реализовать строгую проверку claims JWT: `iss`, `aud`, `exp`, `iat`.
4. Поддерживать список отзыва refresh токенов и обеспечивать его интеграцию с системой логинов.
5. Настроить политики безопасности и реализовать тестирование для проверки корректности работы с JWT.



## ADR: Rate Limiting + 429 + Retry-After (DoS Login Mitigation)

**Status:** Proposed
**Owner:** Security Lead
**Date created:** 2025-10-13

---

### Context

**Risk:** R-03 — *DoS логина (всплеск запросов на `/api/auth/login`)*
**L = 4**, **I = 4**, **Score = 16 (Top-3)**
**DFD:** Edge `Internet → API` (Login endpoint)
**NFR link:** NFR-005 (RateLimiting)
**Assumptions:**

* Публичный REST-эндпойнт `/api/auth/login` без аутентификации.
* Gateway поддерживает rate-limit-middleware (NGINX/Envoy).
* JWT выдаётся после успешного логина.
* Сервис горизонтально масштабируется (Kubernetes ingress).

---

### Decision

Ввести **rate-limiting политику** и глобальные квоты для снижения риска DoS-атаки на точку входа `/api/auth/login`.

* **Param/Policy 1:** `limit = 5 req/min` на пару *(username, IP)*
* **Param/Policy 2:** `limit = 30 req/min` на IP-адрес
* **Param/Policy 3:** превышение лимита → `429 Too Many Requests` + заголовок `Retry-After` (секунды)
* **Param/Policy 4:** глобальные квоты на уровне ingress (1000 req/min per node), burst-bucket защита
* **Layer:** API Gateway / Ingress
* **Scope:** `/api/auth/login` для всех ролей и тенантов
* **Notes:** Лимиты применяются до аутентификации; агрегация метрик в Prometheus (`http_429_total`).

---

### Alternatives

| Альтернатива                                    | Кратко                              | Почему не выбрана                                |
| ----------------------------------------------- | ----------------------------------- | ------------------------------------------------ |
| **A. CAPTCHA / step-up challenge**              | Триггерится после N ошибок          | Замедляет UX, неэффективно против headless-ботов |
| **B. Async login queue**                        | Обработка логинов через очередь     | Слишком сложная архитектура для edge-запросов    |

---

### Consequences

**Положительные:**

* Сокращение вероятности DoS-атаки на точку входа.
* Стабильность UX при всплесках трафика.
* Простое масштабирование и безопасный откат через конфиг.

**Негативные:**
– Возможны ложные срабатывания при массовых входах с одного NAT.
– Нужна синхронизация лимитов между узлами gateway.

---

### DoD / Acceptance

**Given** активный пользователь и установленный лимит 5/30 req/min
**When** выполняется 6-й запрос для той же пары *(username, IP)* в течение 60 секунд
**Then** ответ = `429` с корректным заголовком `Retry-After > 0`
**And** последующие запросы блокируются до истечения окна.

**Checks:**

* **test:** `e2e-rate-limit-login` (вызов > limit → 429)
* **log:** запись `status=429`, `endpoint=/api/auth/login`, `Retry-After` присутствует
* **metric:** `http_429_total` растёт, `error_rate < 1%`
* **policy:** конфиг gateway `limit-req zone=login; burst=5; nodelay;`

---

### Rollback / Fallback

* Флаг `RATE_LIMIT_ENABLED=false` в конфиге ingress.
* Мониторинг метрики `http_429_total`; при росте >10% вернуть прежние пороги.
* Откат лимитов возможен без рестарта (hot reload).

---

### Trace

* **DFD:** `S04.md` → Edge *Internet → API* (`/api/auth/login`)
* **STRIDE:** `S04_stride_matrix` — Threat = D (DoS login)
* **Risk scoring:** `R-03`, Top-3 (Score = 16)
* **NFR:** `NFR-005 (RateLimiting)` из `S03.md`
* **Issues:** `#128` (login rate limit task)

---

### Ownership & Dates

**Owner:** Security Lead
**Reviewers:** BE Lead, SRE
**Date created:** 2025-10-13
**Last updated:** 2025-10-13

---

### Open Questions

* Нужно ли дифференцировать лимиты по ролям (например, для админов)?
* Как синхронизировать счётчики между узлами gateway — Redis или локальные токены?

---

### Appendix

```nginx
limit_req_zone $binary_remote_addr zone=login:10m rate=30r/m;
limit_req zone=login burst=5 nodelay;
add_header Retry-After $limit_req_delay always;
```

### 1) Критерии и шкалы

**Security impact (↑)** — снижение вероятности/влияния DoS.
**Blast radius reduction (↑)** — насколько локализует ущерб.
**Complexity (↓)** — сложность внедрения.
**Time-to-mitigate (↓)** — время до эффекта.
**Dependencies (↓)** — внешние и организационные зависимости.

---

### 2) Таблица сравнения вариантов

| Alternative                         | Summary                                                    | Security impact ↑ | Blast radius reduction ↑ | Complexity ↓ | Time-to-mitigate ↓ | Dependencies ↓ | **Benefit** | **Cost** | **Net** | Notes                                         |
| ----------------------------------- | ---------------------------------------------------------- | ----------------: | -----------------------: | -----------: | -----------------: | -------------: | ----------: | -------: | ------: | --------------------------------------------- |
| **A. RateLimit per (username, IP)** | Ограничение 5 req/min per (username, IP) + 429 Retry-After |                 4 |                        4 |            2 |                  2 |              2 |       **8** |    **6** |  **+2** | Простое, быстрое, даёт немедленный эффект     |
| **B. CAPTCHA / Step-up Challenge**  | Ввод CAPTCHA после N ошибок                                |                 3 |                        3 |            3 |                  3 |              3 |       **6** |    **9** |  **−3** | Замедляет UX, требует фронт-интеграции        |
| **C. Async Login Queue**            | Очередь задач логина (asynchronous processing)             |                 5 |                        5 |            5 |                  5 |              4 |      **10** |   **14** |  **−4** | Сложная архитектура, высокая задержка отклика |

---

### 3) Тай-брейкеры

* **Maintainability:** A проще поддерживать (стандартный middleware).
* **Observability:** у A легко собирать метрики 429 в Prometheus.
* **Rollback safety:** A можно отключить флагом в конфиге без downtime.

---

### 4) Решение (для переноса в ADR)

* **Chosen alternative:** **A — RateLimit per (username, IP)**
* **Почему:** даёт быстрый и измеримый эффект против DoS, не требует сложных зависимостей, не ухудшает UX для нормальных пользователей, безопасно откатывается конфигом.
* **ADR candidate:** *“Rate Limiting + 429 + Retry-After (DoS Login Mitigation)”*
* **Связки:** `Risk-ID R-03`, `NFR-005 (RateLimiting)`, `DFD Edge Internet → API`.
* **Следующие шаги:**

  1. Настроить лимиты в gateway (`limit_req_zone` / rate-limit filter).
  2. Добавить заголовок `Retry-After` и логирование 429.
  3. Настроить мониторинг `http_429_total` и долю ошибок ≤ 1 %.
  4. Документировать параметры лимита в DevOps-playbook.
  5. Добавить автотест `e2e-rate-limit-login`.

---
